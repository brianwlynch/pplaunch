<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/pplaunch.css">
    <script type="text/javascript" src="js/pplaunch.js" defer></script>
    <script src="js/starfield.js" defer></script>
    <script src="js/spaceinvaders.js" defer></script>
    <script src="js/gamelaunch.js" defer></script>
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
    <title>Launching | The Fat Controller</title>

    <script>
        const fs = require('fs');
        const path = require('path');
        const { app } = require('electron').remote || require('@electron/remote');
        const { ipcRenderer } = require('electron');

        const settingsPath = path.join(app.getPath('userData'), 'settings.json');

        var TFC_INSTANCE = null;
        let DEBUG = null;
        let TARGET_URL = null;
        var FirstRun = true;
        let debugIcon;
        let alertIcon;

        
        window.onload = () => {
            debugIcon = document.getElementById("debug_icon");
            alertIcon = document.getElementById("alert_icon");
            loadSettings();
            setInterval(checkServer, 5000);

            document.getElementById('settings_icon').addEventListener('click', () => {
                ipcRenderer.send("open-settings-window");
                if (DEBUG) {
                    console.log("Settings icon clicked, opening settings window.");
                }
            });
            document.getElementById('help_icon').addEventListener('click', () => {
                ipcRenderer.send("open-help-window");
                if (DEBUG) {
                    console.log("Help icon clicked, opening help window.");
                }
            });
        };

        function loadSettings() {
            if (fs.existsSync(settingsPath)) {
                const settings = JSON.parse(fs.readFileSync(settingsPath));

                TFC_INSTANCE = settings.TFC_INSTANCE || '';
                DEBUG = !!settings.DEBUG;
                
                if(DEBUG || FirstRun){
                    console.log("TFC Instance loaded:", TFC_INSTANCE);
                    console.log("Debug mode:", DEBUG);
                }

                if(DEBUG){
                    ipcRenderer.send("debug-active");
                }

                if(debugIcon) debugIcon.style.visibility = DEBUG ? "visible" : "hidden";
                
                FirstRun = false;
            } else {
                console.warn('No settings file found.');
            }
        }

        async function checkServer() {
            loadSettings();
            if (!TFC_INSTANCE || TFC_INSTANCE == "none") {
                console.warn("TFC_INSTANCE not set. Please check your settings!");
                alertIcon.style.visibility = "visible";  
                loadSettings();
                return;
            } else {
                alertIcon.style.visibility = "hidden";   
            }
            
            TARGET_URL = "https://control." + TFC_INSTANCE + ".nepgroup.io/production/pool/panel";
            // TARGET_URL = "https://brianwlynch.com"


            try {
                console.info("Checking TFC at:", TARGET_URL);
                const response = await fetch(TARGET_URL, { method: "GET"});
                const text = await response.text();
                
                if (response.status === 404 || (response.status === 200 && text.includes("404"))){
                        console.error("Failed to fetch! - 404 Not Found")
                        return;
                } else redirect();

            } catch (e) {
                console.warn("Server likely not up yet:", e.message);
            }
        }

        function redirect(){
            if (DEBUG){
                console.warn("Connection to TFC is ok! Won't redirect due to debug mode!");
                return;
            }
            
            if (inGameMode){
                document.getElementById("redirect").classList.add("shown");
                return;
            } else {
                // window.location.href = TARGET_URL;
                ipcRenderer.send("open-tfc-window", TARGET_URL);
            }
        }
        function redirectGame(){
            if (DEBUG){
                console.warn("Connection to TFC is ok! Won't redirect due to debug mode!");
                return;
            } else window.location.href = TARGET_URL;
        }
        
        ipcRenderer.on('settings-updated', () => {
            loadSettings();
            console.log("Loading Settings");
        });
    </script>
</head>

<body>
    <img id="debug_icon" src="assets/images/debug.svg" class="debug_icon"/>
    <table style="position: absolute; right: 0; top: 0;">
        <td>
            <img id="alert_icon" src="assets/images/alert.svg" class="alert_icon"/>
        </td>
        <td>
            <img id="help_icon" src="assets/images/help.svg" class="help_icon"/>
        </td>
        <td>
            <img id="settings_icon" src="assets/images/settings.svg" class="settings_icon"/>
        </td>
    </table>

    <div id="main-container" class="container">
        <div id="title" class="title">TFC Is Launching</div>
        <div id="message" class="subtitle">This page will automatically refresh when ready.</div>
    </div>
    <img id="rocket-img" class="rocket" src="assets/images/rocket.gif" onclick="launchGame()"></img>

    <div id="redirect" class="redirect" onclick="redirectGame()">
        <h1 class="title_2">TFC is ready</h1>
        <h4 class="subtitle_2">Click me to open TFC!</h4>
    </div>

    <div id="game-container">
        <div id="starfield" style="opacity: 0%;"></div>
        <div id="gamecontainer">
            <canvas id="gameCanvas"></canvas>
        </div>
        <!-- <div id="info">
            <p>Swipe to move left and right. Tap the screen to shoot.</p>
        </div> -->
    </div>
    <div class="footer">
        <img src="assets/images/volume-off.svg"
            onclick="toggleMute()"
            id="muteIcon"
            class="mute"/>
        <p id="footer">PPLaunch v3.0.1 &nbsp; | &nbsp; August 2, 2025</p>
    </div>
</body>

</html>