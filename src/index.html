<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/pplaunch.css">
    <script type="text/javascript" src="js/pplaunch.js" defer></script>
    <script src="js/starfield.js" defer></script>
    <script src="js/spaceinvaders.js" defer></script>
    <script src="js/gamelaunch.js" defer></script>
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
    <title>Launching | The Fat Controller</title>

    <script>
        const fs = require('fs');
        const path = require('path');
        const { app } = require('electron').remote || require('@electron/remote');

        const settingsPath = path.join(app.getPath('userData'), 'settings.json');

        var TFC_INSTANCE = null;
        let DEBUG = null;
        let TARGET_URL = null;
        var FirstRun = true;

        window.onload = () => {
            loadSettings();
            setInterval(checkServer, 5000);
        };

        function loadSettings() {
            if (fs.existsSync(settingsPath)) {
                const settings = JSON.parse(fs.readFileSync(settingsPath));

                TFC_INSTANCE = settings.TFC_INSTANCE || '';
                DEBUG = !!settings.DEBUG;
                
                if(DEBUG || FirstRun){
                    console.log("TFC Instance loaded:", TFC_INSTANCE);
                    console.log("Debug mode:", DEBUG);
                }

                const debugIcon = document.getElementById("debug_icon");
                if(debugIcon) debugIcon.style.visibility = DEBUG ? "visible" : "hidden";

                FirstRun = false;
            } else {
            console.warn('No settings file found.');
            }
        }

        async function checkServer() {
            loadSettings();
            if (!TFC_INSTANCE || TFC_INSTANCE == "none") {
                if(DEBUG){
                    console.warn("TFC_INSTANCE not yet available, skipping this check.");
                };
                loadSettings();
                return;
            }
            
            TARGET_URL = "https://control." + TFC_INSTANCE + ".nepgroup.io/production/pool/panel";

            try {
                const response = await fetch(TARGET_URL, { method: "GET"});
                console.info("Checking server at:", TARGET_URL);
                const text = await response.text();
                
                if (response.status === 404 || (response.status === 200 && text.includes("404"))){
                        console.error("Failed to fetch! - 404 Not Found")
                        return;
                } else redirect();

            } catch (e) {
                console.warn("Server likely not up yet:", e.message);
            }
        }

        function redirect(){
            if (DEBUG){
                console.warn("Debug mode activated! Won't redirect!");
                return;
            }
            
            if (inGameMode){
                document.getElementById("redirect").classList.add("shown");
                return;
            } else {
                window.location.href = TARGET_URL;
            }
        }
        function redirectGame(){
            if (DEBUG){
                console.warn("Debug mode activated! Won't redirect!");
                return;
            } else window.location.href = TARGET_URL;
        }
    </script>
</head>

<body>
    <img id="debug_icon" src="assets/images/bug.svg" class="debug_icon"/>
    <div id="main-container" class="container">
        <div id="title" class="title">TFC Is Launching</div>
        <div id="message" class="subtitle">This page will automatically refresh when ready.</div>
    </div>
    <img id="rocket-img" class="rocket" src="assets/images/rocket.gif" onclick="launchGame()"></img>

    <div id="redirect" class="redirect" onclick="redirectGame()">
        <h1 class="title_2">TFC is ready</h1>
        <h4 class="subtitle_2">Click me to open TFC!</h4>
    </div>

    <div id="game-container">
        <div id="starfield" style="opacity: 0%;"></div>
        <div id="gamecontainer">
            <canvas id="gameCanvas"></canvas>
        </div>
        <!-- <div id="info">
            <p>Swipe to move left and right. Tap the screen to shoot.</p>
        </div> -->
    </div>
    <div class="footer">
        <img src="assets/images/volume-off.svg"
            onclick="toggleMute()"
            id="muteIcon"
            class="mute"/>
        <p id="footer">PPLaunch v3.0.0 &nbsp; | &nbsp; June 2025</p>
    </div>
</body>

</html>