<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/pplaunch.css">
    <script type="text/javascript" src="js/pplaunch.js" defer></script>
    <script src="js/starfield.js" defer></script>
    <script src="js/spaceinvaders.js" defer></script>
    <script src="js/gamelaunch.js" defer></script>
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
    <title>Launching | The Fat Controller</title>

    <script>
        var TFC_INSTANCE = null;
        var DEBUG = null;
        var TARGET_URL = null;
        var BASE_URL = null;
        var CUSTOM_INSTANCE = null;

        var FirstRun = true;
        let debugIcon;
        let alertIcon;


        
        window.onload = () => {
            debugIcon = document.getElementById("debug_icon");
            alertIcon = document.getElementById("alert_icon");
            loadSettings();
            setInterval(checkServer, 5000);

            document.getElementById('settings_icon').addEventListener('click', () => {
                window.appAPI.openSettings();
                if (DEBUG) {
                    console.log("Settings icon clicked, opening settings window.");
                }
            });
            document.getElementById('help_icon').addEventListener('click', () => {
                window.appAPI.openHelp();
                if (DEBUG) {
                    console.log("Help icon clicked, opening help window.");
                }
            });
        };

        function loadSettings() {
            const settings = window.settingsAPI.load()
            if (Object.keys(settings).length === 0) {
                console.warn('No settings file found.');
            } else {
                TFC_INSTANCE = settings.TFC_INSTANCE || '';
                DEBUG = !!settings.DEBUG;
                
                if(DEBUG || FirstRun){
                    console.log("TFC Instance loaded:", TFC_INSTANCE);
                    console.log("Debug mode:", DEBUG);
                }
                FirstRun = false;

                if(DEBUG){
                    window.appAPI.debugActive();
                }

                if(debugIcon) debugIcon.style.visibility = DEBUG ? "visible" : "hidden";

                BASE_URL = settings.BASE_URL || "nep";
                CUSTOM_INSTANCE = settings.CUSTOM_INSTANCE || "";
                
            }
        }

        async function checkServer() {
            loadSettings();
            if (!TFC_INSTANCE || TFC_INSTANCE == "none") {
                console.warn("TFC_INSTANCE not set. Please check your settings!");
                alertIcon.style.visibility = "visible";  
                loadSettings();
                return;
            } else {
                alertIcon.style.visibility = "hidden";   
            }

            if (!CUSTOM_INSTANCE && BASE_URL == "custom") {
                console.warn("CUSTOM_URL not set. Please check your settings!");
                alertIcon.style.visibility = "visible";  
                loadSettings();
                return;
            } else {
                alertIcon.style.visibility = "hidden";   
            }
            
            switch(BASE_URL) {
                case "nep":
                    TARGET_URL = "https://control." + TFC_INSTANCE + ".nepgroup.io/production/pool/panel";
                    break;
                case "tfc":
                    TARGET_URL = "https://control." + TFC_INSTANCE + ".tfclabs.com/production/pool/panel";
                    break;
                case "demo":
                    TARGET_URL = "https://nepgroup.com";
                    break;
                case "custom":
                    TARGET_URL = CUSTOM_INSTANCE;
                    break;
                default:
                    TARGET_URL = "";
            }


            try {
                console.info("Checking TFC at:", TARGET_URL);
                const response = await fetch(TARGET_URL, { method: "GET"});
                const text = await response.text();
                
                if (response.status === 404 || (response.status === 200 && text.includes("404"))){
                        console.error("Failed to fetch! - 404 Not Found")
                        return;
                } else redirect();

            } catch (e) {
                console.warn("Server likely not up yet:", e.message);
            }
        }

        function redirect(){
            if (DEBUG){
                console.warn("Connection to TFC is ok! Won't redirect due to debug mode!");
                return;
            }
            
            if (inGameMode){
                document.getElementById("redirect").classList.add("shown");
                return;
            } else window.appAPI.openTFC(TARGET_URL);
        }
        function redirectGame(){
            if (DEBUG){
                console.warn("Connection to TFC is ok! Won't redirect due to debug mode!");
                return;
            } else window.appAPI.openTFC(TARGET_URL);
        }
        
        // ipcRenderer.on('settings-updated', () => {
        //     loadSettings();
        //     console.log("Loading Settings");
        // });
    </script>
</head>

<body>
    <img id="debug_icon" src="assets/images/debug.svg" class="debug_icon"/>
    <table style="position: absolute; right: 0; top: 0;">
        <td>
            <img id="alert_icon" src="assets/images/alert.svg" class="alert_icon"/>
        </td>
        <td>
            <img id="help_icon" src="assets/images/help.svg" class="help_icon"/>
        </td>
        <td>
            <img id="settings_icon" src="assets/images/settings.svg" class="settings_icon"/>
        </td>
    </table>

    <div id="main-container" class="container">
        <div id="title" class="title">TFC Is Launching</div>
        <div id="message" class="subtitle">This page will automatically refresh when ready.</div>
    </div>
    <img id="rocket-img" class="rocket" src="assets/images/rocket.gif" onclick="launchGame()"></img>

    <div id="redirect" class="redirect" onclick="redirectGame()">
        <h1 class="title_2">TFC is ready</h1>
        <h4 class="subtitle_2">Click me to open TFC!</h4>
    </div>

    <div id="game-container">
        <div id="starfield" style="opacity: 0%;"></div>
        <div id="gamecontainer">
            <canvas id="gameCanvas"></canvas>
        </div>
        <!-- <div id="info">
            <p>Swipe to move left and right. Tap the screen to shoot.</p>
        </div> -->
    </div>
    <div class="footer">
        <img src="assets/images/volume-off.svg"
            onclick="toggleSFXMute()"
            id="sfxIcon"
            class="sound-controls"/>
        <img src="assets/images/music-off.svg"
            onclick="toggleMusicMute()"
            id="musicIcon"
            class="sound-controls"/>
        <p id="footer">PPLaunch v3.1.1 &nbsp; | &nbsp; August 11, 2025</p>
    </div>
</body>

</html>